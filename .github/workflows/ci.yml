name: ğŸš€ CI/CD Pipeline

# ĞšĞ¾Ğ»Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚Ğ¸ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
env:
  NODE_VERSION: "18"

jobs:
  # ğŸ§ª Ğ•Ñ‚Ğ°Ğ¿ Ñ‚ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest

    steps:
      # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ ĞºĞ¾Ğ´
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ĞĞ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ–
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑÑ‚Ğ¸Ğ»ÑŒ ĞºĞ¾Ğ´Ñƒ
      - name: ğŸ¨ Run ESLint
        run: npm run lint --if-present

      # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸
      - name: ğŸ§ª Run tests
        run: npm test -- --coverage --watchAll=false

      # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ Ñ‚ĞµÑÑ‚Ñ–Ğ²
      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

  # ğŸ—ï¸ Ğ•Ñ‚Ğ°Ğ¿ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build

      # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ±Ñ–Ñ€ĞºÑƒ ÑĞº Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ (Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ²ĞµÑ€ÑÑ–Ñ v4)
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 7

  # ğŸš€ Ğ•Ñ‚Ğ°Ğ¿ Ñ€Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ main Ğ³Ñ–Ğ»ĞºĞ¸)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: build/

      # Ğ¢ÑƒÑ‚ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ€Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ Ğ½Ğ° Vercel, Netlify, Ñ‚Ğ¾Ñ‰Ğ¾
      - name: ğŸ‰ Deployment successful
        run: echo "ğŸš€ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğ´Ğ¾ Ñ€Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ!"
